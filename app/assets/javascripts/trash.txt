@data[p.symbol][:price].to_f * p.shares - p.total_cost

showPositions = ->
  yql_url = "https://query.yahooapis.com/v1/public/yql"
  query = "SELECT * FROM yahoo.finance.quotes WHERE symbol in ('"
  if gon.symbols
    generate_query = (rest..., last) ->
      for r in rest
        query += r + "', '"
      if last?
        query += last + "')"
    generate_query.apply(null, gon.symbols)
    $.ajax
      type: "GET"
      url: yql_url
      data:
        q: query
        format: "json"
        env: "store://datatables.org/alltableswithkeys"
      dataType: "jsonp"
      success: (data) ->
        console.log data

def market_open?
  # returns true if the stock market is open

  t=Time.now.in_time_zone('Eastern Time (US & Canada)')
  market_open = Time.new(t.year, t.month, t.day, 9, 30, 0, t.utc_offset)
  market_close  = Time.new(t.year, t.month, t.day, 16, 0, 0, t.utc_offset)

  t.between?(market_open, market_close)
end

def update_cumulative_dividends
  query = "use 'store://bg2cgClQyQC1c5gJE3UXUn' as yahoo.finance.dividendhistory; select * from yahoo.finance.dividendhistory where symbol = '" + self[:symbol] + "' and startDate = '" + self[:date_acquired].strftime("%Y-%m-%d") + "' and endDate = '" + Date.today.strftime("%Y-%m-%d") + "'"
  response = self.class.get '/v1/public/yql', query: { q: query }
  cumulative_dividends = 0.0
  if response.success? && response["query"]["results"] != nil
    response = response["query"]["results"]["quote"]
    response = [response] unless response.kind_of?(Array)
    response.each do |r|
      cumulative_dividends += r["Dividends"].to_f
    end
  end
  update_attributes cumulative_dividends: (cumulative_dividends * self[:shares]).to_f
end

def update_price
  query = "SELECT * FROM yahoo.finance.quotes WHERE symbol in ('" + self[:symbol] + "')"
  response = self.class.get '/v1/public/yql', query: { q: query }
  if response.success? && response["query"]["results"]["quote"]["ErrorIndicationreturnedforsymbolchangedinvalid"] == nil
      update_attributes price: response["query"]["results"]["quote"]["LastTradePriceOnly"].to_f
  end
end